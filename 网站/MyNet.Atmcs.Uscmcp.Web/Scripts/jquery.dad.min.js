$(function () {
    function O_dad() {
        var self = this;
        this.x = 0;
        this.y = 0;
        this.target = false;
        this.clone = false;
        this.placeholder = false;

        this.cloneoffset = {
            x: 0,
            y: 0
        };
        this.move = function (e) {
            self.x = e.pageX;
            self.y = e.pageY;
            if (self.clone != false && self.target != false) {
                self.clone.css({
                    top: self.y - self.cloneoffset.y,
                    left: self.x - self.cloneoffset.x
                })
            } else { }
        };
        $(window).on('mousemove',
        function (e) {
            self.move(e)
        })
    }
    O_dad();

    $.prototype.dad = function (opts) {
        var me, defaults, options;
        me = this;

        defaults = {
            target: 'li.item',
            draggable: false,
            placeholder: '',
            callback: false,
            containerClass: 'dad-container',
            childrenClass: 'dads-children',
            cloneClass: 'dads-children-clone',
            active: true
        };
        options = $.extend({},
        defaults, opts);
        $(this).each(function () {
            var mouse, target, dragClass, active, callback, placeholder, daddy, childrenClass, jQclass, cloneClass;
            mouse = new O_dad();
            active = options.active;

            daddy = $(this);
            childrenClass = options.childrenClass;
            cloneClass = options.cloneClass;
            jQclass = '.' + childrenClass;
            daddy.addClass(options.containerClass);
            target = daddy.find(options.target);
            callback = options.callback;
            me.addDropzone = function (selector, func) {
                $(selector).on('mouseenter', function () {
                    if (mouse.target != false) {
                        $(this).addClass('active');
                        $("#PanelHead_Content .screenlist div.active").css("color", "#fc5004");
                    }
                }).on('mouseup',
                function () {
                    if (mouse.target != false) {
                        clearTimeout(mouse.target.timer); // 2016.3.30 小宁 新增 计时器开关
                        func(mouse.target);
                        dad_end()
                    }
                    $(this).removeClass('active')
                }).on('mouseleave',
                function () {
                    $("#PanelHead_Content .screenlist div").css("color", "white");
                    $(this).removeClass('active');
                    $("#PanelHead").animate({ height: "0px" });
                })
            };
            $(document).on('mouseup',
            function () {
                clearTimeout(mouse.target.timer); // 2016.3.30 小宁 新增 计时器开关
                $("#PanelHead .header").css("height", "90px");
                $("#PanelHead .x-panel-body:first-child").css("height", "90px");
                $("#PanelHead_Content .screenlist div").css("color", "white");
                //鼠标离开事件

                dad_end()
            });

            $('.screenlist').ckSlide({ frequency: opts.fre });
            var order = 1;
            target.addClass(childrenClass).each(function () {
                order++
            });
            function update_position(e) {
                var order = 1;
                e.find(jQclass).each(function () {
                    order++
                })
            }
            function dad_end() {
                if (mouse.target != false && mouse.clone != false) {
                    if (callback != false) {
                        callback(mouse.target)
                    }
                    var appear = mouse.target;
                    var desapear = mouse.clone;
                    var holder = mouse.placeholder;
                    var bLeft = 0;
                    var bTop = 0;
                    if ($.contains(daddy[0], mouse.target[0])) {
                        mouse.clone.animate({
                            top: mouse.target.offset().top - daddy.offset().top - bTop,
                            left: mouse.target.offset().left - daddy.offset().left - bLeft,
                        },
                        300,
                        function () {
                            appear.removeClass('active');
                            desapear.remove()
                            $(".screenlist").fadeOut();
                        })
                    } else {
                        mouse.clone.fadeOut(300,
                        function () {
                            desapear.remove()
                        })
                    }
                    holder.remove();
                    mouse.clone = false;
                    mouse.placeholder = false;
                    mouse.target = false;
                    update_position(daddy)
                }
            }
            var jq = (options.draggable != false) ? options.draggable : jQclass;
            daddy.find(jq).addClass(dragClass);
            daddy.find(jq).on('mousedown touchstart',
            function (e) {
                if (/*mouse.target == false && */e.which == 1 && active == true) { // 2016.3.30 小宁 修改
                    if (options.draggable != false) {
                        mouse.target = daddy.find(jQclass).has(this)
                    } else {
                        mouse.target = $(this)
                    }

                    mouse.target.timer = setTimeout(function () {   // 2016.3.30 小宁 新增 计时器
                        if (mouse.target.index() == 0) {
                            $(".screenlist").fadeOut();
                        }
                        else {
                            mouse.clone = mouse.target.clone();
                            mouse.target.addClass('active');
                            $(".screenlist").fadeIn();
                            mouse.clone.addClass(cloneClass);
                            daddy.append(mouse.clone);

                            mouse.placeholder = $('<div></div>');
                            mouse.placeholder.addClass('dads-children-placeholder');
                        }
                        mouse.placeholder.css({
                            top: mouse.target.offset().top - daddy.offset().top,
                            left: mouse.target.offset().left - daddy.offset().left,
                            width: mouse.target.outerWidth() - 10,
                            height: mouse.target.outerHeight() - 10,
                            lineHeight: mouse.target.height() - 18 + 'px',
                            textAlign: 'center'
                        }).text(placeholder);
                        daddy.append(mouse.placeholder);
                        var difx, dify;
                        var bLeft = Math.floor(parseFloat(daddy.css('border-left-width')));
                        var bTop = Math.floor(parseFloat(daddy.css('border-top-width')));
                        difx = mouse.x - mouse.target.offset().left + daddy.offset().left + bLeft;
                        dify = mouse.y - mouse.target.offset().top + daddy.offset().top + bTop;
                        mouse.cloneoffset.x = difx;
                        mouse.cloneoffset.y = dify;
                        mouse.clone.removeClass(childrenClass).css({
                            position: 'absolute',
                            top: mouse.y - mouse.cloneoffset.y,
                            left: mouse.x - mouse.cloneoffset.x
                        }); /*鼠标按住一秒  头部变高*/

                        //$("#PanelHead_Content .screenlist div").css("color","#fc5004")
                        $("#PanelHead .header").css("height", "1080px");
                        $("#PanelHead .x-panel-body:first-child").css("height", "1080px");
                    }, 1000); // 2016.3.30 小宁 新增计时器
                    //$("html,body").addClass('dad-noSelect')
                }
            });
        });
        return this
    }
})